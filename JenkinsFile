// Jenkinsfile  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pipeline {
  agent any               // exÃ©cute sur n'importe quel agent Linux Jenkins

  environment {
    // Bun pour l'utilisateur jenkins
    BUN_INSTALL = "${HOME}/.bun"
    PATH = "${env.BUN_INSTALL}/bin:${env.PATH}"

    // Dossier (dÃ©jÃ  servi par /etc/systemd/system/nuxt-serve.service)
    DEPLOY_DIR = '/home/julien/site-perso/.output/public'
  }

  options {
    // Garde seulement les 15 derniers logs pour ne pas saturer le disque
    buildDiscarder(logRotator(numToKeepStr: '15'))
  }

  stages {

    stage('Checkout') {
      steps {
        sshagent(credentials: ['github-ssh']) {
          checkout scm                       // clone la branche dÃ©clencheuse
        }
      }
    }

    stage('Install & Build') {
      steps {
        sh '''
          echo "ğŸ”§ Installing dependencies..."
          bun install

          echo "ğŸ—  Building Nuxt static..."
          bunx nuxi generate                # crÃ©e .output/public
        '''
      }
    }

    stage('Deploy') {
      steps {
        sh '''
          echo "ğŸšš Deploying to ${DEPLOY_DIR} ..."
          rsync -a --delete .output/public/ ${DEPLOY_DIR}/
        '''
      }
    }

    stage('Restart service') {
      steps {
        sh 'sudo -n systemctl restart nuxt-serve'
      }
    }
  }

  post {
    success {
      echo 'âœ…  Deployment succeeded!'
    }
    failure {
      echo 'âŒ  Deployment failed!'
    }
  }
}
