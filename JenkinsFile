// Jenkinsfile  ───────────────────────────────────────────────
pipeline {
  agent any               // exécute sur n'importe quel agent Linux Jenkins

  environment {
    // Bun pour l'utilisateur jenkins
    BUN_INSTALL = "${HOME}/.bun"
    PATH = "${env.BUN_INSTALL}/bin:${env.PATH}"

    // Dossier (déjà servi par /etc/systemd/system/nuxt-serve.service)
    DEPLOY_DIR = '/home/julien/site-perso/.output/public'
  }

  options {
    // Garde seulement les 15 derniers logs pour ne pas saturer le disque
    buildDiscarder(logRotator(numToKeepStr: '15'))
  }

  stages {

    stage('Checkout') {
      steps {
        sshagent(credentials: ['github-ssh']) {
          checkout scm                       // clone la branche déclencheuse
        }
      }
    }

    stage('Install & Build') {
      steps {
        sh '''
          echo "🔧 Installing dependencies..."
          bun install

          echo "🏗  Building Nuxt static..."
          bunx nuxi generate                # crée .output/public
        '''
      }
    }

    stage('Deploy') {
      steps {
        sh '''
          echo "🚚 Deploying to ${DEPLOY_DIR} ..."
          rsync -a --delete .output/public/ ${DEPLOY_DIR}/
        '''
      }
    }

    stage('Restart service') {
      steps {
        sh 'sudo -n systemctl restart nuxt-serve'
      }
    }
  }

  post {
    success {
      echo '✅  Deployment succeeded!'
    }
    failure {
      echo '❌  Deployment failed!'
    }
  }
}
